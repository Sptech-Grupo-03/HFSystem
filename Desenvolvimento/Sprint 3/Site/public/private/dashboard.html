<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - HFSystem</title>
    <link rel="stylesheet" href="./css/dashboardHF.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://assets.hgbrasil.com/weather/js/hg-weather-1.0.js" type="text/javascript"></script>
</head>

<body onload="exibirHistoricoReservatorio()">
    <section class="container">
        <header>
            <div class="logo">
                <img src="assets/logotipo-texto-branco (1) 1.png" alt="">
            </div>

            <div class="menu">
                <a href="menu.html"><i class="fa-solid fa-house"></i></a>
                <span>Menu</span>
                <i class="fa-solid fa-bell"></i>
                <span>Notificações</span>
            </div>
            <div class="user">
                <span id="barra">|</span>
                <img src="assets/user.png" alt="">
                <span>Claudio Frizzarini</span>
                <span id="barra">|</span>
            </div>
            <div class="hamburger">
                <i class="fa-solid fa-bars" id="hamburger-icon"></i>
            </div>

            <div class="sidebar" id="sidebar">
                <ul>
                    <li class="option">OPÇÕES</li>
                    <li><i class="fa-solid fa-gear"></i>Configurações</li>
                    <li><i class="fa-solid fa-door-open"></i>Sair</li>
                </ul>
            </div>
        </header>
        <main>
            <!-- navegador de paginas  -->
            <div class="pgAtual">
                <div class="indicadorPagina">
                    <i class="fa-solid fa-laptop"></i>
                    <span>Dashboard</span>
                </div>
                <div class="caminhoPagina">
                    <i class="fa-solid fa-house-circle-check"> </i>
                    <span> / Reservatório 2 / Consultar reservatório</span>
                </div>
            </div>

            <!-- começo kpis -->
            <div class="kpis">
                <div class="conjuntokpi">
                    <div class="kpi1 kpiPrincipal">
                        <span class="tituloKpi">ÁGUA DISPONÍVEL</span>
                        <select name="" id="">
                            <option value="" disabled selected></option>
                            <option value="">Metros cúbicos (m³)</option>
                            <option value="">Porcentagem (%)</option>
                            <option value="">Litros (L)</option>
                        </select>
                        <img id="kpiPrincipalImg" src="assets/reservatorio-kpi.png" alt="">
                        <span id="nivelAtual" class="nivelAtual"></span>
                    </div>

                    <div class="kpi1">
                        <span class="tituloKpi">SITUAÇÃO RESERVATÓRIO</span>
                        <span id="situacaoAtual" class="infoKpi">AVISO</span>
                        <img src="assets/reservatorio-kpi.png" alt="">
                    </div>

                    <div class="kpi1 consumo">
                        <div class="tituloKpi">
                            <span>CONSUMO MÉDIO</span>
                            <select name="" id="">
                                <option value="" disabled selected>Visualizar em:</option>
                                <option value="">Metros cúbicos (m³)</option>
                                <option value="">Porcentagem (%)</option>
                                <option value="">Litros (L)</option>
                            </select>
                        </div>

                        <span id="consumoMedio" class="infoKpi"></span>
                        <div class="icon">
                            <i class="fa-solid fa-droplet"></i>
                            <div class="upAndDown">
                                <i id="up" class="fa-solid fa-caret-up"></i>
                                <i id="down" class="fa-solid fa-caret-down"></i>
                            </div>
                        </div>
                    </div>

                    <div id="nivelCritico" class="kpi1">
                        <span class="tituloKpi">VERIFICAÇÃO ESAVAZIAMENTO</span>
                        <span id="vezesNivelCritico" class="infoKpi">2 VEZES</span>
                        <i class="fa-solid fa-droplet-slash"></i>
                    </div>
                    <div class="kpi1">
                        <span class="tituloKpi">DIAS DE ÁGUA RESTANTES</span>
                        <span id="estimativaDias" class="infoKpi"></span>
                        <i class="fa-solid fa-faucet-drip"></i>
                    </div>
                </div>
            </div>

            <div class="graficos">
                <div class="grafico">
                    <span>FLUXO DE ÁGUA NO RESERVATORIO</span>
                    <canvas id="fluxoAgua" width="500" height="210"></canvas>
                </div>

                <div class="previsaoClima">
                    <span class="titulo">
                        CLIMATEMPO HOJE
                    </span>

                    <div class="infoTempo">
                        <div class="cardPrevisao probChuva">
                            <div class="infos">
                                <span>PROB. CHUVA<br></span>
                                <span id="probChuva">Obtendo...</span>
                            </div>
                            <i class="fa-solid fa-cloud-rain"></i>
                        </div>

                        <div class="cardPrevisao tempMaxima">
                            <div class="infos">
                                <div class="low-high">
                                    <span>Temp. Máxima<br></span>
                                    <span id="tempMaxima"></span>
                                </div>
                            </div>
                            <i class="fa-solid fa-temperature-arrow-up"></i>
                        </div>

                        <div class="cardPrevisao tempMinima">
                            <div class="infos">
                                <span>TEMP. MINÍMA<br></span>
                                <span id="tempMinima"></span>
                            </div>
                            <i class="fa-solid fa-temperature-arrow-down"></i>
                        </div>

                        <div class="cardPrevisao umidadeAr">
                            <div class="infos">
                                <div class="hg-weather" data-key="c381e5f5" data-woeid="455827">
                                    <span data-weather="message"></span>
                                    <span>UMIDADE DO AR<br></span>
                                    <span data-weather="humidity" id="umidadeAr"></span> %
                                </div>
                            </div>
                            <i class="fa-solid fa-wind"></i>
                            <!-- <img style="height: 1px;" data-weather="image">
                                <img style="height: 1px;" data-weather="image"> -->
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </section>
    </main>
    </section>
</body>

</html>

<script src="js/configclima.js"></script>
<script src="js/dash.js"></script>
<script src="js/registerClima.js"></script>

<script>

    function exibirHistoricoReservatorio() {

        const idReservatorio = sessionStorage.idReservatorio

        fetch(`/historicoReservatorio/exibirDadosReservatorio?idReservatorio=${idReservatorio}`)
            .then(function (resposta) {
                console.log("resposta: ", resposta);

                if (resposta.ok) {
                    console.log(
                        "Dados recuperados com sucesso"
                    );
                    resposta.json().then(json => {
                        console.log(resposta)
                        console.log(json);
                        console.log(JSON.stringify(json));
                        sessionStorage.dadosReservatorio = JSON.stringify(json.reservatorio);
                        defineDadosReservatorio();
                    });

                    return true;
                } else {
                    throw "Houve um erro ao tentar resgatar os dados!";
                }
            })
            .catch(function (resposta) {
                console.log(`#ERRO: ${resposta}`);
            });
        return false;

    }

    function defineDadosReservatorio() {
        let dadosString = sessionStorage.getItem('dadosReservatorio');
        let dados = JSON.parse(dadosString);

        document.getElementById("nivelAtual").innerHTML = `${dados[0][0]["Nivel Atual"]}%`;
        document.getElementById("situacaoAtual").innerHTML = `${dados[1][0]["situacaoAtual"]}`;
        document.getElementById("consumoMedio").innerHTML = `${dados[4][0]["Media Nivel Calculado"]}`;
        document.getElementById("vezesNivelCritico").innerHTML = `${dados[2][0]["AtingiuNivelCritico"]} VEZES`;
        document.getElementById("estimativaDias").innerHTML = `${dados[5][0]["ConsumoEstimado"]} DIAS`;

        let labels = [];
        let dataNiveis = [];
        dados[3].forEach(entry => {
            labels.push(entry.dtHrNivel);
            dataNiveis.push(entry.Nivel);
        });

        atualizarGrafico(labels, dataNiveis);
    }

    function atualizarGrafico(labels, dataNiveis) {
    const ctx = document.getElementById('fluxoAgua').getContext('2d');

    const horarioLabels = ['01h', '02h', '03h', '04h', '05h', '06h', '07h', '08h', '09h', '10h', '11h'];
    const dataNiveis1 = [4, 4, 3.50, 3, 2.50, 2, 2, 2, 2, 3, 4];

    const data = {
        labels: horarioLabels,
        datasets: [
            {
                label: 'Nível Atual',
                data: dataNiveis1,
                borderColor: 'cyan',
                borderWidth: 2,
                pointBackgroundColor: 'cyan',
                pointBorderColor: 'black',
                pointRadius: 5,
                fill: true,
                backgroundColor: 'rgba(0, 123, 167, 0.3)',
                order: 1 // Garantir que fique atrás das métricas
            },
            {
                label: 'Nível Ideal',
                data: Array(horarioLabels.length).fill(4.50),
                borderColor: 'green',
                borderWidth: 2,
                fill: false,
                pointRadius: 0,
                order: 2 // Garantir que fique visível
            },
            {
                label: 'Nível Alerta',
                data: Array(horarioLabels.length).fill(2.50),
                borderColor: 'yellow',
                borderWidth: 2,
                fill: false,
                pointRadius: 0,
                order: 2
            },
            {
                label: 'Nível de Risco',
                data: Array(horarioLabels.length).fill(1.50),
                borderColor: 'red',
                borderWidth: 2,
                fill: false,
                pointRadius: 0,
                order: 2
            }
        ]
    };

    const config = {
        type: 'line',
        data: data,
        options: {
            responsive: true,
            scales: {
                x: {
                    ticks: {
                        font: {
                            size: 14,
                            weight: 'bold'
                        },
                        color: 'black'
                    },
                    grid: { display: false }
                },
                y: {
                    position: 'left',
                    title: {
                        display: true,
                        text: 'Volume (Metros)',
                        font: { size: 15 }
                    },
                    min: 1.20,
                    max: 5,
                    ticks: {
                        callback: function (value) {
                            if (value === 1.50 || value === 2.50 || value === 4.50) {
                                return value + 'm';
                            }
                        },
                        font: {
                            size: 16,
                            weight: 'bold'
                        },
                        color: 'black'
                    },
                    grid: { display: false }
                }
            },
            plugins: {
                legend: {
                    labels: {
                        font: {
                            size: 18
                        },
                        color: 'black',
                        boxWidth: 20,
                        padding: 15,
                        generateLabels: function (chart) {
                            const original = Chart.defaults.plugins.legend.labels.generateLabels;
                            const labels = original.call(this, chart);
                            labels.forEach((label, index) => {
                                label.fillStyle = chart.data.datasets[index].borderColor;
                            });
                            return labels;
                        }
                    }
                },
            },
            elements: {
                line: {
                    borderCapStyle: 'round',
                    borderJoinStyle: 'round'
                }
            }
        }
    };

    // Inicializa o gráfico
    new Chart(ctx, config);
}
</script>